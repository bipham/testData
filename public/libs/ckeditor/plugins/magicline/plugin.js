"use strict";!function(){function e(e,t,n){return g(t)&&g(n)&&n.equals(t.getNext(function(e){return!(J(e)||Q(e)||p(e))}))}function t(e){this.upper=e[0],this.lower=e[1],this.set.apply(this,e.slice(2))}function n(e){var t,n=e.element;if(n&&g(n)){if((t=n.getAscendant(e.triggers,!0))&&e.editable.contains(t)){var i=l(t);return"true"==i.getAttribute("contenteditable")?t:i.is(e.triggers)?i:null}return null}return null}function i(e,t,n){v(e,t),v(e,n);var i=t.size.bottom,o=n.size.top;return i&&o?0|(i+o)/2:i||o}function o(e,t,n){return t=t[n?"getPrevious":"getNext"](function(t){return f(t)&&!J(t)||g(t)&&!p(t)&&!u(e,t)})}function r(e,t,n){return e>t&&e<n}function l(e,t){if(e.data("cke-editable"))return null;for(t||(e=e.getParent());e;){if(e.data("cke-editable"))return null;if(e.hasAttribute("contenteditable"))return e;e=e.getParent()}return null}function a(e){var t=e.doc,n=I('<span contenteditable="false" style="'+V+"position:absolute;border-top:1px dashed "+e.boxColor+'"></span>',t),i=CKEDITOR.getUrl(this.path+"images/"+(z.hidpi?"hidpi/":"")+"icon"+(e.rtl?"-rtl":"")+".png");R(n,{attach:function(){return this.wrap.getParent()||this.wrap.appendTo(e.editable,!0),this},lineChildren:[R(I('<span title="'+e.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',t),{base:V+"height:17px;width:17px;"+(e.rtl?"left":"right")+":17px;background:url("+i+") center no-repeat "+e.boxColor+";cursor:pointer;"+(z.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":"")+(z.hidpi?"background-size: 9px 10px;":""),looks:["top:-8px; border-radius: 2px;","top:-17px; border-radius: 2px 2px 0px 0px;","top:-1px; border-radius: 0px 0px 2px 2px;"]}),R(I(j,t),{base:X+"left:0px;border-left-color:"+e.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),R(I(j,t),{base:X+"right:0px;border-right-color:"+e.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],detach:function(){return this.wrap.getParent()&&this.wrap.remove(),this},mouseNear:function(){e.debug.groupStart("mouseNear"),v(e,this);var t=e.holdDistance,n=this.size;return n&&r(e.mouse.y,n.top-t,n.bottom+t)&&r(e.mouse.x,n.left-t,n.right+t)?(e.debug.logEnd("Mouse is near."),!0):(e.debug.logEnd("Mouse isn't near."),!1)},place:function(){var t=e.view,n=e.editable,i=e.trigger,o=i.upper,l=i.lower,a=o||l,d=a.getParent(),s={};this.trigger=i,o&&v(e,o,!0),l&&v(e,l,!0),v(e,d,!0),e.inInlineMode&&y(e,!0),d.equals(n)?(s.left=t.scroll.x,s.right=-t.scroll.x,s.width=""):(s.left=a.size.left-a.size.margin.left+t.scroll.x-(e.inInlineMode?t.editable.left+t.editable.border.left:0),s.width=a.size.outerWidth+a.size.margin.left+a.size.margin.right+t.scroll.x,s.right=""),o&&l?o.size.margin.bottom===l.size.margin.top?s.top=0|o.size.bottom+o.size.margin.bottom/2:o.size.margin.bottom<l.size.margin.top?s.top=o.size.bottom+o.size.margin.bottom:s.top=o.size.bottom+o.size.margin.bottom-l.size.margin.top:o?l||(s.top=o.size.bottom+o.size.margin.bottom):s.top=l.size.top-l.size.margin.top,i.is(_)||r(s.top,t.scroll.y-15,t.scroll.y+5)?(s.top=e.inInlineMode?0:t.scroll.y,this.look(_)):i.is(B)||r(s.top,t.pane.bottom-5,t.pane.bottom+15)?(s.top=e.inInlineMode?t.editable.height+t.editable.padding.top+t.editable.padding.bottom:t.pane.bottom-1,this.look(B)):(e.inInlineMode&&(s.top-=t.editable.top+t.editable.border.top),this.look($)),e.inInlineMode&&(s.top--,s.top+=t.editable.scroll.top,s.left+=t.editable.scroll.left);for(var u in s)s[u]=CKEDITOR.tools.cssLength(s[u]);this.setStyles(s)},look:function(e){if(this.oldLook!=e){for(var t,n=this.lineChildren.length;n--;)(t=this.lineChildren[n]).setAttribute("style",t.base+t.looks[0|e/2]);this.oldLook=e}},wrap:new O("span",e.doc)});for(var o=n.lineChildren.length;o--;)n.lineChildren[o].appendTo(n);n.look($),n.appendTo(n.wrap),n.unselectable(),n.lineChildren[0].on("mouseup",function(t){n.detach(),d(e,function(t){var n=e.line.trigger;t[n.is(k)?"insertBefore":"insertAfter"](n.is(k)?n.lower:n.upper)},!0),e.editor.focus(),z.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),t.data.preventDefault(!0)}),n.on("mousedown",function(e){e.data.preventDefault(!0)}),e.line=n}function d(e,t,n){var i,o=new CKEDITOR.dom.range(e.doc),r=e.editor;if(z.ie&&e.enterMode==CKEDITOR.ENTER_BR)i=e.doc.createText(q);else{var a=l(e.element,!0),d=a&&a.data("cke-enter-mode")||e.enterMode;(i=new O(S[d],e.doc)).is("br")||e.doc.createText(q).appendTo(i)}n&&r.fire("saveSnapshot"),t(i),o.moveToPosition(i,CKEDITOR.POSITION_AFTER_START),r.getSelection().selectRanges([o]),e.hotNode=i,n&&r.fire("saveSnapshot")}function s(e,t){return{canUndo:!0,modes:{wysiwyg:1},exec:function(){function i(n){var i=z.ie&&z.version<9?" ":q,o=e.hotNode&&e.hotNode.getText()==i&&e.element.equals(e.hotNode)&&e.lastCmdDirection===!!t;d(e,function(i){o&&e.hotNode&&e.hotNode.remove(),i[t?"insertAfter":"insertBefore"](n),i.setAttributes({"data-cke-magicline-hot":1,"data-cke-magicline-dir":!!t}),e.lastCmdDirection=!!t}),z.ie||e.enterMode==CKEDITOR.ENTER_BR||e.hotNode.scrollIntoView(),e.line.detach()}return function(r){var a,d=r.getSelection().getStartElement();if(d=d.getAscendant(G,1),!m(e,d)&&d&&!d.equals(e.editable)&&!d.contains(e.editable)){(a=l(d))&&"false"==a.getAttribute("contenteditable")&&(d=a),e.element=d;var s,u=o(e,d,!t);if(g(u)&&u.is(e.triggers)&&u.is(U)&&(!o(e,u,!t)||(s=o(e,u,!t))&&g(s)&&s.is(e.triggers)))i(u);else{var c=n(e,d);if(g(c))if(o(e,c,!t)){var p=o(e,c,!t);p&&g(p)&&p.is(e.triggers)&&i(c)}else i(c)}}}}()}}function u(e,t){if(!t||t.type!=CKEDITOR.NODE_ELEMENT||!t.$)return!1;var n=e.line;return n.wrap.equals(t)||n.wrap.contains(t)}function g(e){return e&&e.type==CKEDITOR.NODE_ELEMENT&&e.$}function c(e){if(!g(e))return!1;var t={left:1,right:1,center:1};return!(!t[e.getComputedStyle("float")]&&!t[e.getAttribute("align")])}function p(e){return!!g(e)&&(h(e)||c(e))}function h(e){return!!{absolute:1,fixed:1}[e.getComputedStyle("position")]}function f(e){return e&&e.type==CKEDITOR.NODE_TEXT}function b(e,t){return g(t)?t.is(e.triggers):null}function m(e,t){if(!t)return!1;for(var n=t.getParents(1),i=n.length;i--;)for(var o=e.tabuList.length;o--;)if(n[i].hasAttribute(e.tabuList[o]))return!0;return!1}function E(e,t,n){var i=t[n?"getLast":"getFirst"](function(t){return e.isRelevant(t)&&!t.is(H)});return!!i&&(v(e,i),n?i.size.top>e.mouse.y:i.size.bottom<e.mouse.y)}function w(e){e.debug.groupStart("triggerEditable");var n,i=e.editable,o=e.mouse,l=e.view,a=e.triggerOffset;y(e);var d=o.y>(e.inInlineMode?l.editable.top+l.editable.height/2:Math.min(l.editable.height,l.pane.height)/2),s=i[d?"getLast":"getFirst"](function(e){return!(J(e)||Q(e))});return s?(u(e,s)&&(s=e.line.wrap[d?"getPrevious":"getNext"](function(e){return!(J(e)||Q(e))})),g(s)&&!p(s)&&b(e,s)?(v(e,s),!d&&s.size.top>=0&&r(o.y,0,s.size.top+a)?(n=e.inInlineMode||0===l.scroll.y?_:$,e.debug.logEnd("SUCCESS. Created box trigger. EDGE_TOP."),new t([null,s,k,K,n])):d&&s.size.bottom<=l.pane.height&&r(o.y,s.size.bottom-a,l.pane.height)?(n=e.inInlineMode||r(s.size.bottom,l.pane.height-a,l.pane.height)?B:$,e.debug.logEnd("SUCCESS. Created box trigger. EDGE_BOTTOM."),new t([s,null,L,K,n])):(e.debug.logEnd("ABORT. No trigger created."),null)):(e.debug.logEnd("ABORT. Invalid edge node."),null)):(e.debug.logEnd("ABORT. No edge node found."),null)}function x(e){e.debug.groupStart("triggerEdge");var i=e.mouse,l=e.view,a=e.triggerOffset,d=n(e);if(e.debug.logElements([d],["Ascendant trigger"],"First stage"),!d)return e.debug.logEnd("ABORT. No element, element is editable or element contains editable."),null;v(e,d);var s,u,c=Math.min(a,0|d.size.outerHeight/2),h=[];if(r(i.y,d.size.top-1,d.size.top+c))u=!1;else{if(!r(i.y,d.size.bottom-c,d.size.bottom+1))return e.debug.logEnd("ABORT. Not around of any edge."),null;u=!0}if(p(d)||E(e,d,u)||d.getParent().is(F))return e.debug.logEnd("ABORT. element is wrong",d),null;var m=o(e,d,!u);if(m){if(f(m))return e.debug.logEnd("ABORT. Sibling is non-empty text element"),null;if(g(m)){if(p(m)||!b(e,m)||m.getParent().is(F))return e.debug.logEnd("ABORT. elementSibling is wrong",m),null;h=[m,d][u?"reverse":"concat"]().concat([P,K]),e.debug.log("Configured edge trigger of EDGE_MIDDLE")}}else d.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?(y(e),u&&r(i.y,d.size.bottom-c,l.pane.height)&&r(d.size.bottom,l.pane.height-c,l.pane.height)?s=B:r(i.y,0,d.size.top+c)&&(s=_)):s=$,h=[null,d][u?"reverse":"concat"]().concat([u?L:k,K,s,d.equals(e.editable[u?"getLast":"getFirst"](e.isRelevant))?u?B:_:$]),e.debug.log("Configured edge trigger of "+(u?"EDGE_BOTTOM":"EDGE_TOP"));return 0 in h?(e.debug.logEnd("SUCCESS. Returning a trigger."),new t(h)):(e.debug.logEnd("ABORT. No trigger generated."),null)}function T(e,t,n,i){function o(e){return t.getComputedStyle.call(t,e)}for(var r=t.getDocumentPosition(),l={},a={},d={},s={},u=ee.length;u--;)l[ee[u]]=parseInt(o("border-"+ee[u]+"-width"),10)||0,d[ee[u]]=parseInt(o("padding-"+ee[u]),10)||0,a[ee[u]]=parseInt(o("margin-"+ee[u]),10)||0;return n&&!i||D(e,i),s.top=r.y-(n?0:e.view.scroll.y),s.left=r.x-(n?0:e.view.scroll.x),s.outerWidth=t.$.offsetWidth,s.outerHeight=t.$.offsetHeight,s.height=s.outerHeight-(d.top+d.bottom+l.top+l.bottom),s.width=s.outerWidth-(d.left+d.right+l.left+l.right),s.bottom=s.top+s.outerHeight,s.right=s.left+s.outerWidth,e.inInlineMode&&(s.scroll={top:t.$.scrollTop,left:t.$.scrollLeft}),R({border:l,padding:d,margin:a,ignoreScroll:n},s,!0)}function v(e,t,n){if(!g(t))return t.size=null;if(t.size){if(t.size.ignoreScroll==n&&t.size.date>new Date-W)return e.debug.log("element.size: get from cache"),null}else t.size={};return e.debug.log("element.size: capture"),R(t.size,T(e,t,n),{date:+new Date},!0)}function y(e,t){e.view.editable=T(e,e.editable,t,!0)}function D(e,t){e.view||(e.view={});var n=e.view;if(!t&&n&&n.date>new Date-W)e.debug.log("win.size: get from cache");else{e.debug.log("win.size: capturing");var i=e.win,o=i.getScrollPosition(),r=i.getViewPaneSize();R(e.view,{scroll:{x:o.x,y:o.y,width:e.doc.$.documentElement.scrollWidth-r.width,height:e.doc.$.documentElement.scrollHeight-r.height},pane:{width:r.width,height:r.height,bottom:r.height+o.y},date:+new Date},!0)}}function C(e,n,i,o){for(var r=o,l=o,a=0,d=!1,s=!1,u=e.view.pane.height,g=e.mouse;g.y+a<u&&g.y-a>0&&(d||(d=n(r,o)),s||(s=n(l,o)),!d&&g.y-a>0&&(r=i(e,{x:g.x,y:g.y-a})),!s&&g.y+a<u&&(l=i(e,{x:g.x,y:g.y+a})),!d||!s);)a+=2;return new t([r,l,null,null])}CKEDITOR.plugins.add("magicline",{lang:"af,ar,az,bg,ca,cs,cy,da,de,de-ch,el,en,en-gb,eo,es,es-mx,et,eu,fa,fi,fr,fr-ca,gl,he,hr,hu,id,it,ja,km,ko,ku,lv,nb,nl,no,oc,pl,pt,pt-br,ru,si,sk,sl,sq,sv,tr,tt,ug,uk,vi,zh,zh-cn",init:function(e){var i,l,c,f=e.config,b=f.magicline_triggerOffset||30,E=f.enterMode,v={editor:e,enterMode:E,triggerOffset:b,holdDistance:0|b*(f.magicline_holdDistance||.5),boxColor:f.magicline_color||"#ff0000",rtl:"rtl"==f.contentsLangDirection,tabuList:["data-cke-hidden-sel"].concat(f.magicline_tabuList||[]),triggers:f.magicline_everywhere?G:{table:1,hr:1,div:1,ul:1,ol:1,dl:1,form:1,blockquote:1}};try{v.debug=window.top.DEBUG}catch(e){}v.debug=v.debug||{groupEnd:function(){},groupStart:function(){},log:function(){},logElements:function(){},logElementsEnd:function(){},logEnd:function(){},mousePos:function(){},showHidden:function(){},showTrigger:function(){},startTimer:function(){},stopTimer:function(){}},v.isRelevant=function(e){return g(e)&&!u(v,e)&&!p(e)},e.on("contentDom",function(){function g(t){v.debug.groupStart("CheckMouse"),v.debug.startTimer(),v.mouse=t,v.trigger=null,c=null,D(v),l&&!v.hiddenMode&&e.focusManager.hasFocus&&!v.line.mouseNear()&&(v.element=Y(v,!0))&&((v.trigger=w(v)||x(v)||Z(v))&&!m(v,v.trigger.upper||v.trigger.lower)?v.line.attach().place():(v.trigger=null,v.line.detach()),v.debug.showTrigger(v.trigger),v.debug.mousePos(t.y,v.element),l=!1),v.debug.stopTimer(),v.debug.groupEnd()}var p=e.editable(),b=e.document,E=e.window;R(v,{editable:p,inInlineMode:p.isInline(),doc:b,win:E,hotNode:null},!0),v.boundary=v.inInlineMode?v.editable:v.doc.getDocumentElement(),p.is(N.$inline)||(v.inInlineMode&&!h(p)&&p.setStyles({position:"relative",top:null,left:null}),a.call(this,v),D(v),p.attachListener(e,"beforeUndoImage",function(){v.line.detach()}),p.attachListener(e,"beforeGetData",function(){v.line.wrap.getParent()&&(v.line.detach(),e.once("getData",function(){v.line.attach()},null,null,1e3))},null,null,0),p.attachListener(v.inInlineMode?b:b.getWindow().getFrame(),"mouseout",function(t){if("wysiwyg"==e.mode)if(v.inInlineMode){var n={x:t.data.$.clientX,y:t.data.$.clientY};D(v),y(v,!0);var i=v.view.editable,o=v.view.scroll;r(n.x,i.left-o.x,i.right-o.x)&&r(n.y,i.top-o.y,i.bottom-o.y)||(clearTimeout(c),c=null,v.line.detach())}else clearTimeout(c),c=null,v.line.detach()}),p.attachListener(p,"keyup",function(){v.hiddenMode=0,v.debug.showHidden(v.hiddenMode)}),p.attachListener(p,"keydown",function(t){if("wysiwyg"==e.mode){switch(t.data.getKeystroke()){case 2228240:case 16:v.hiddenMode=1,v.line.detach()}v.debug.showHidden(v.hiddenMode)}}),p.attachListener(v.inInlineMode?p:b,"mousemove",function(t){if(l=!0,"wysiwyg"==e.mode&&!e.readOnly&&!c){var n={x:t.data.$.clientX,y:t.data.$.clientY};c=setTimeout(function(){g(n)},30)}}),p.attachListener(E,"scroll",function(){"wysiwyg"==e.mode&&(v.line.detach(),z.webkit&&(v.hiddenMode=1,clearTimeout(i),i=setTimeout(function(){v.mouseDown||(v.hiddenMode=0),v.debug.showHidden(v.hiddenMode)},50),v.debug.showHidden(v.hiddenMode)))}),p.attachListener(M?b:E,"mousedown",function(){"wysiwyg"==e.mode&&(v.line.detach(),v.hiddenMode=1,v.mouseDown=1,v.debug.showHidden(v.hiddenMode))}),p.attachListener(M?b:E,"mouseup",function(){v.hiddenMode=0,v.mouseDown=0,v.debug.showHidden(v.hiddenMode)}),e.addCommand("accessPreviousSpace",s(v)),e.addCommand("accessNextSpace",s(v,!0)),e.setKeystroke([[f.magicline_keystrokePrevious,"accessPreviousSpace"],[f.magicline_keystrokeNext,"accessNextSpace"]]),e.on("loadSnapshot",function(){var t,n,i;for(var o in{p:1,br:1,div:1})for(i=(t=e.document.getElementsByTag(o)).count();i--;)if((n=t.getItem(i)).data("cke-magicline-hot"))return v.hotNode=n,void(v.lastCmdDirection="true"===n.data("cke-magicline-dir"))}),this.backdoor={accessFocusSpace:d,boxTrigger:t,isLine:u,getAscendantTrigger:n,getNonEmptyNeighbour:o,getSize:T,that:v,triggerEdge:x,triggerEditable:w,triggerExpand:Z})},this)}});var R=CKEDITOR.tools.extend,O=CKEDITOR.dom.element,I=O.createFromHtml,z=CKEDITOR.env,M=CKEDITOR.env.ie&&CKEDITOR.env.version<9,N=CKEDITOR.dtd,S={},k=128,L=64,P=32,K=16,A=8,_=4,B=2,$=1,q=" ",F=N.$listItem,H=N.$tableContent,U=R({},N.$nonEditable,N.$empty),G=N.$block,W=100,V="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",X=V+"border-color:transparent;display:block;border-style:solid;",j="<span>"+q+"</span>";S[CKEDITOR.ENTER_BR]="br",S[CKEDITOR.ENTER_P]="p",S[CKEDITOR.ENTER_DIV]="div",t.prototype={set:function(e,t,n){return this.properties=e+t+(n||$),this},is:function(e){return(this.properties&e)==e}};var Y=function(){function e(e,t){var n=e.$.elementFromPoint(t.x,t.y);return n&&n.nodeType?new CKEDITOR.dom.element(n):null}return function(t,n,i){if(!t.mouse)return null;var o=t.doc,r=t.line.wrap,l=i||t.mouse,a=e(o,l);return n&&u(t,a)&&(r.hide(),a=e(o,l),r.show()),a&&a.type==CKEDITOR.NODE_ELEMENT&&a.$?z.ie&&z.version<9&&!t.boundary.equals(a)&&!t.boundary.contains(a)?null:a:null}}(),J=CKEDITOR.dom.walker.whitespaces(),Q=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),Z=function(){function t(t){t.debug.groupStart("expandEngine");var r,l,a,d=t.element;if(!g(d)||d.contains(t.editable))return t.debug.logEnd("ABORT. No start element, or start element contains editable."),null;if(d.isReadOnly())return null;if(a=C(t,function(e,t){return!t.equals(e)},function(e,t){return Y(e,!0,t)},d),r=a.upper,l=a.lower,t.debug.logElements([r,l],["Upper","Lower"],"Pair found"),e(t,r,l))return t.debug.logEnd("SUCCESS. Expand trigger created."),a.set(P,A);if(t.debug.logElements([d,r,l],["Start","Upper","Lower"],"Post-processing"),r&&d.contains(r))for(;!r.getParent().equals(d);)r=r.getParent();else r=d.getFirst(function(e){return n(t,e)});if(l&&d.contains(l))for(;!l.getParent().equals(d);)l=l.getParent();else l=d.getLast(function(e){return n(t,e)});if(!r||!l)return t.debug.logEnd("ABORT. There is no upper or no lower element."),null;if(v(t,r),v(t,l),!o(t,r,l))return t.debug.logEnd("ABORT. Mouse is already above upper or below lower."),null;for(var s,u,c,p,h=Number.MAX_VALUE;l&&!l.equals(r)&&(u=r.getNext(t.isRelevant));)(s=Math.abs(i(t,r,u)-t.mouse.y))<h&&(h=s,c=r,p=u),v(t,r=u);return t.debug.logElements([c,p],["Min","MinNext"],"Post-processing results"),c&&p?o(t,c,p)?(a.upper=c,a.lower=p,t.debug.logEnd("SUCCESSFUL post-processing. Trigger created."),a.set(P,A)):(t.debug.logEnd("ABORT. Mouse is already above minElement or below minElementNext."),null):(t.debug.logEnd("ABORT. No Min or MinNext"),null)}function n(e,t){return!(f(t)||Q(t)||p(t)||u(e,t)||t.type==CKEDITOR.NODE_ELEMENT&&t.$&&t.is("br"))}function o(e,t,n){return r(e.mouse.y,t.size.top,n.size.bottom)}function l(t,n){t.debug.groupStart("expandFilter");var i=n.upper,o=n.lower;return!i||!o||p(o)||p(i)||o.equals(i)||i.equals(o)||o.contains(i)||i.contains(o)?(t.debug.logEnd("REJECTED. No upper or no lower or they contain each other."),!1):b(t,i)&&b(t,o)&&e(t,i,o)?(t.debug.logElementsEnd([i,o],["upper","lower"],"APPROVED EDGE_MIDDLE"),!0):(t.debug.logElementsEnd([i,o],["upper","lower"],"Rejected unknown pair"),!1)}return function(e){e.debug.groupStart("triggerExpand");var n=t(e);return e.debug.groupEnd(),n&&l(e,n)?n:null}}(),ee=["top","left","right","bottom"]}(),CKEDITOR.config.magicline_keystrokePrevious=CKEDITOR.CTRL+CKEDITOR.SHIFT+51,CKEDITOR.config.magicline_keystrokeNext=CKEDITOR.CTRL+CKEDITOR.SHIFT+52;