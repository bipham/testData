"use strict";!function(){function e(e){this.editor=e,this.loaders=[]}function t(e,t,o){var r,s=e.config.fileTools_defaultFileName;this.editor=e,this.lang=e.lang,"string"==typeof t?(this.data=t,this.file=a(this.data),this.total=this.file.size,this.loaded=this.total):(this.data=null,this.file=t,this.total=this.file.size,this.loaded=0),o?this.fileName=o:this.file.name?this.fileName=this.file.name:(r=this.file.type.split("/"),s&&(r[0]=s),this.fileName=r.join(".")),this.uploaded=0,this.uploadTotal=null,this.responseData=null,this.status="created",this.abort=function(){this.changeStatus("abort")}}function a(e){var t,a,r,s,l,n=e.match(o)[1],i=e.replace(o,""),d=atob(i),u=[];for(t=0;t<d.length;t+=512){for(a=d.slice(t,t+512),r=new Array(a.length),s=0;s<a.length;s++)r[s]=a.charCodeAt(s);l=new Uint8Array(r),u.push(l)}return new Blob(u,{type:n})}CKEDITOR.plugins.add("filetools",{lang:"az,ca,cs,da,de,de-ch,en,eo,es,es-mx,eu,fr,gl,hr,hu,id,it,ja,km,ko,ku,nb,nl,oc,pl,pt,pt-br,ru,sk,sv,tr,ug,uk,zh,zh-cn",beforeInit:function(t){t.uploadRepository=new e(t),t.on("fileUploadRequest",function(e){var t=e.data.fileLoader;t.xhr.open("POST",t.uploadUrl,!0),e.data.requestData.upload={file:t.file,name:t.fileName}},null,null,5),t.on("fileUploadRequest",function(e){var t=e.data.fileLoader,a=new FormData,o=e.data.requestData;for(var r in o){var s=o[r];"object"==typeof s&&s.file?a.append(r,s.file,s.name):a.append(r,s)}a.append("ckCsrfToken",CKEDITOR.tools.getCsrfToken()),t.xhr.send(a)},null,null,999),t.on("fileUploadResponse",function(e){var t=e.data.fileLoader,a=t.xhr,o=e.data;try{var r=JSON.parse(a.responseText);if(r.error&&r.error.message&&(o.message=r.error.message),r.uploaded)for(var s in r)o[s]=r[s];else e.cancel()}catch(r){o.message=t.lang.filetools.responseError,CKEDITOR.warn("filetools-response-error",{responseText:a.responseText}),e.cancel()}},null,null,999)}}),e.prototype={create:function(e,a){var o=this.loaders.length,r=new t(this.editor,e,a);return r.id=o,this.loaders[o]=r,this.fire("instanceCreated",r),r},isFinished:function(){for(var e=0;e<this.loaders.length;++e)if(!this.loaders[e].isFinished())return!1;return!0}},t.prototype={loadAndUpload:function(e,t){var a=this;this.once("loaded",function(o){o.cancel(),a.once("update",function(e){e.cancel()},null,null,0),a.upload(e,t)},null,null,0),this.load()},load:function(){var e=this;this.reader=new FileReader;var t=this.reader;e.changeStatus("loading"),this.abort=function(){e.reader.abort()},t.onabort=function(){e.changeStatus("abort")},t.onerror=function(){e.message=e.lang.filetools.loadError,e.changeStatus("error")},t.onprogress=function(t){e.loaded=t.loaded,e.update()},t.onload=function(){e.loaded=e.total,e.data=t.result,e.changeStatus("loaded")},t.readAsDataURL(this.file)},upload:function(e,t){var a=t||{};e?(this.uploadUrl=e,this.xhr=new XMLHttpRequest,this.attachRequestListeners(),this.editor.fire("fileUploadRequest",{fileLoader:this,requestData:a})&&this.changeStatus("uploading")):(this.message=this.lang.filetools.noUrlError,this.changeStatus("error"))},attachRequestListeners:function(){function e(){"error"!=a.status&&(a.message=a.lang.filetools.networkError,a.changeStatus("error"))}function t(){"abort"!=a.status&&a.changeStatus("abort")}var a=this,o=this.xhr;a.abort=function(){o.abort(),t()},o.onerror=e,o.onabort=t,o.upload?(o.upload.onprogress=function(e){e.lengthComputable&&(a.uploadTotal||(a.uploadTotal=e.total),a.uploaded=e.loaded,a.update())},o.upload.onerror=e,o.upload.onabort=t):(a.uploadTotal=a.total,a.update()),o.onload=function(){if(a.update(),"abort"!=a.status)if(a.uploaded=a.uploadTotal,o.status<200||o.status>299)a.message=a.lang.filetools["httpError"+o.status],a.message||(a.message=a.lang.filetools.httpError.replace("%1",o.status)),a.changeStatus("error");else{for(var e={fileLoader:a},t=["message","fileName","url"],r=a.editor.fire("fileUploadResponse",e),s=0;s<t.length;s++){var l=t[s];"string"==typeof e[l]&&(a[l]=e[l])}a.responseData=e,delete a.responseData.fileLoader,!1===r?a.changeStatus("error"):a.changeStatus("uploaded")}}},changeStatus:function(e){this.status=e,"error"!=e&&"abort"!=e&&"loaded"!=e&&"uploaded"!=e||(this.abort=function(){}),this.fire(e),this.update()},update:function(){this.fire("update")},isFinished:function(){return!!this.status.match(/^(?:loaded|uploaded|error|abort)$/)}},CKEDITOR.event.implementOn(e.prototype),CKEDITOR.event.implementOn(t.prototype);var o=/^data:(\S*?);base64,/;CKEDITOR.fileTools||(CKEDITOR.fileTools={}),CKEDITOR.tools.extend(CKEDITOR.fileTools,{uploadRepository:e,fileLoader:t,getUploadUrl:function(e,t){var a=CKEDITOR.tools.capitalize;return t&&e[t+"UploadUrl"]?e[t+"UploadUrl"]:e.uploadUrl?e.uploadUrl:t&&e["filebrowser"+a(t,1)+"UploadUrl"]?e["filebrowser"+a(t,1)+"UploadUrl"]+"&responseType=json":e.filebrowserUploadUrl?e.filebrowserUploadUrl+"&responseType=json":null},isTypeSupported:function(e,t){return!!e.type.match(t)}})}();