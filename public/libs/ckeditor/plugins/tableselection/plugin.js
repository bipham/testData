!function(){"use strict";function e(e,t){function n(e){return e.getAscendant("tr",!0).$.rowIndex}var o,a,l,r,s,i=e.getAscendant("table"),d=t.getAscendant("table"),c=CKEDITOR.tools.buildTableMap(i),u=n(e),g=n(t),f=[],m={};for(i.contains(d)&&(g=n(t=t.getAscendant({td:1,th:1}))),u>g&&(l=u,u=g,g=l,l=e,e=t,t=l),l=0;l<c[u].length;l++)if(e.$===c[u][l]){o=l;break}for(l=0;l<c[g].length;l++)if(t.$===c[g][l]){a=l;break}for(o>a&&(l=o,o=a,a=l),l=u;l<=g;l++)for(r=o;r<=a;r++)(s=new CKEDITOR.dom.element(c[l][r])).$&&!s.getCustomData("selected_cell")&&(f.push(s),CKEDITOR.dom.element.setMarker(m,s,"selected_cell",!0));return CKEDITOR.dom.element.clearAllMarkers(m),f}function t(e){var t=e.data.$;return CKEDITOR.env.ie&&CKEDITOR.env.version<9?1===t.button:0===t.button}function n(e){var t=e.editable().findOne("."+I);return t&&t.getAscendant("table")}function o(e,t){var n,o=e.editable().find("."+I);for(e.fire("lockSnapshot"),e.editable().removeClass(p),n=0;n<o.count();n++)o.getItem(n).removeClass(I);o.count()>0&&o.getItem(0).getAscendant("table").removeClass(h),e.fire("unlockSnapshot"),t&&(v={active:!1},e.getSelection().isInTable()&&e.getSelection().reset())}function a(e,t){var n,o,a=[];for(o=0;o<t.length;o++)(n=e.createRange()).setStartBefore(t[o]),n.setEndAfter(t[o]),a.push(n);e.getSelection().selectRanges(a)}function l(t){var n=t.editable().find("."+I);n.count()<1||a(t,n=e(n.getItem(0),n.getItem(n.count()-1)))}function r(t,n,l){var r,s=E(t.getSelection(!0)),i=n.is("table")?null:n;if(v.active&&!v.first&&(i||function(e,t){var n=e.getRanges();return!!(t.length>1||n[0]&&!n[0].collapsed)}(t.getSelection(),s)))return v.first=i||s[0],void(v.dirty=!i&&1!==s.length);if(v.active&&i&&v.first.getAscendant("table").equals(i.getAscendant("table"))){if(r=e(v.first,i),!v.dirty&&1===r.length)return o(t,"mouseup"===l.name);v.dirty=!0,v.last=i,a(t,r)}}function s(e){var t,n,a,l=e.editor||e.sender.editor,r=l&&l.getSelection(),s=r&&r.getRanges()||[];if(r&&(o(l),r.isInTable()&&r.isFake)){for(1===s.length&&s[0]._getTableElement()&&s[0]._getTableElement().is("table")&&(n=s[0]._getTableElement()),t=E(r,n),l.fire("lockSnapshot"),a=0;a<t.length;a++)t[a].addClass(I);t.length>0&&(l.editable().addClass(p),t[0].getAscendant("table").addClass(h)),l.fire("unlockSnapshot")}}function i(e){function a(e,t){return!(!e||!t)&&(e.equals(t)||e.contains(t)||t.contains(e)||e.getCommonAncestor(t).is(m))}function s(e){return!e.getAscendant("table",!0)&&e.getDocument().equals(d.document)}if(e.data.getTarget().getName){var d=e.editor||e.listenerData.editor,c=(d.getSelection(1),n(d)),u=e.data.getTarget(),g=u&&u.getAscendant({td:1,th:1},!0),f=u&&u.getAscendant("table",!0),m={table:1,thead:1,tbody:1,tfoot:1,tr:1,td:1,th:1};(function(e,n,o,l){return!("mousedown"!==e.name||!t(e)&&l)||"mouseup"===e.name&&!s(e.data.getTarget())&&!a(o,l)})(e,0,c,f)&&o(d,!0),!v.active&&"mousedown"===e.name&&t(e)&&f&&(v={active:!0},CKEDITOR.document.on("mouseup",i,null,{editor:d})),(g||f)&&r(d,g||f,e),"mouseup"===e.name&&(t(e)&&(s(e.data.getTarget())||a(c,f))&&l(d),v={active:!1},CKEDITOR.document.removeListener("mouseup",i))}}function d(e){var t=e.data.getTarget().getAscendant({td:1,th:1},!0);t&&!t.hasClass(I)&&(e.cancel(),e.data.preventDefault())}function c(e,t){var n,o,a,l,r=e.getSelection(),s=r.createBookmarks(),i=e.document,d=e.createRange(),c=i.getDocumentElement().$,u=CKEDITOR.env.ie&&CKEDITOR.env.version<9,g=e.blockless||CKEDITOR.env.ie?"span":"div";i.getById("cke_table_copybin")||(n=i.createElement(g),(o=i.createElement(g)).setAttributes({id:"cke_table_copybin","data-cke-temp":"1"}),n.setStyles({position:"absolute",width:"1px",height:"1px",overflow:"hidden"}),n.setStyle("ltr"==e.config.contentsLangDirection?"left":"right","-5000px"),n.setHtml(e.getSelectedHtml(!0)),e.fire("lockSnapshot"),o.append(n),e.editable().append(o),l=e.on("selectionChange",function(e){e.cancel()},null,null,0),u&&(a=c.scrollTop),d.selectNodeContents(n),d.select(),u&&(c.scrollTop=a),setTimeout(function(){o.remove(),r.selectBookmarks(s),l.removeListener(),e.fire("unlockSnapshot"),t&&(e.extractSelectedHtml(),e.fire("saveSnapshot"))},100))}function u(e){var t=e.editor||e.sender.editor;t.getSelection().isInTable()&&c(t,"cut"===e.name)}function g(t){function n(e){var t,n=0;for(t=0;t<e.length;t++)e[t].length>n&&(n=e[t].length);return n}function o(e){var t,n=e.getAscendant("table"),o=e.getParent().$.rowIndex,a=CKEDITOR.tools.buildTableMap(n);for(t=0;t<a[o].length;t++)if(new CKEDITOR.dom.element(a[o][t]).equals(e))return t}var l,r,s,i,d,c,u,g,f,m,I,h,p,v,R,D,O,K,S=t.editor,w=S.dataProcessor,k=S.getSelection(),A=new CKEDITOR.dom.element("body"),y=0,x=0,L=0,N=0,$={};if(w||(w=new CKEDITOR.htmlDataProcessor(S)),A.setHtml(w.toHtml(t.data.dataValue),{fixForBody:!1}),d=A.findOne("table"),k.getRanges().length&&(k.isInTable()||(l=function(e){var t=k.getRanges()[0],n=t.endContainer.getAscendant("tr",!0);if(n&&t.collapsed){if(t.checkBoundaryOfElement(n,CKEDITOR.START))return 1;if(t.checkBoundaryOfElement(n,CKEDITOR.END))return 2}return 0}()))&&(i=E(k)).length){if(t.stop(),r=i[0].getAscendant("table"),i=E(k,r),u=i[0],f=u.getParent(),m=i[i.length-1],h=m.getParent(),!l)for(O=0;O<i.length;O++)i[O].setHtml("");if(A.getChildCount()>1||!d)return i[0].setHtml(A.getHtml()),void S.fire("saveSnapshot");if(l){for(I=f.getChildCount(),(f=h=new CKEDITOR.dom.element("tr"))["insert"+(1===l?"Before":"After")](u.getParent()),O=0;O<I;O++)(u=new CKEDITOR.dom.element("td")).appendTo(f);u=f.getFirst(),m=f.getLast(),k.selectElement(f),i=E(k)}if(s=CKEDITOR.tools.buildTableMap(r,f.$.rowIndex,C(u,!0),h.$.rowIndex,o(m)),c=CKEDITOR.tools.buildTableMap(d),L=n(c),N=n(s),c.length>s.length)for(y=c.length-s.length,O=0;O<y;O++)T(i);if(L>N)for(x=L-N,O=0;O<x;O++)b(i);for(f=(u=i[0]).getParent(),m=i[i.length-1],m=(h=new CKEDITOR.dom.element(r.$.rows[m.getParent().$.rowIndex+y])).getChild(m.$.cellIndex+x),g=C(i[0],!0),I=o(m),s=CKEDITOR.tools.buildTableMap(r,f.$.rowIndex,g,h.$.rowIndex,I),O=0;O<c.length;O++)for(p=new CKEDITOR.dom.element(r.$.rows[f.$.rowIndex+O]),K=0;K<c[O].length;K++)R=new CKEDITOR.dom.element(c[O][K]),D=s[O]&&s[O][K]?new CKEDITOR.dom.element(s[O][K]):null,R&&!R.getCustomData("processed")?(D&&D.getParent()?R.replace(D):(0===K||c[O][K-1])&&((v=0!==K?new CKEDITOR.dom.element(c[O][K-1]):null)&&p.equals(v.getParent())?R.insertAfter(v):g>0?R.insertAfter(new CKEDITOR.dom.element(p.$.cells[g])):p.append(R,!0)),CKEDITOR.dom.element.setMarker($,R,"processed",!0)):R.getCustomData("processed")&&D&&D.remove();CKEDITOR.dom.element.clearAllMarkers($),a(S,e(new CKEDITOR.dom.element(c[0][0]),R)),S.fire("saveSnapshot"),setTimeout(function(){S.fire("afterPaste")},0)}}function f(e,t,n){e.on("beforeCommandExec",function(n){-1!==CKEDITOR.tools.array.indexOf(t,n.data.name)&&(n.data.selectedCells=E(e.getSelection()))}),e.on("afterCommandExec",function(o){-1!==CKEDITOR.tools.array.indexOf(t,o.data.name)&&n(e,o.data)})}var m,E,C,T,b,I="cke_table-faked-selection",h=I+"-table",p=I+"-editor",v={active:!1};CKEDITOR.plugins.tableselection={getCellsBetween:e,keyboardIntegration:function(e){function t(e){e.getEnclosedNode()?e.getEnclosedNode().setText(""):e.deleteContents(),CKEDITOR.tools.array.forEach(e._find("td"),function(e){e.appendBogus()})}var n=e.editable();n.attachListener(n,"keydown",function(e){function n(t,n){if(!n.length)return null;var o=e.createRange(),l=CKEDITOR.dom.range.mergeRanges(n);CKEDITOR.tools.array.forEach(l,function(e){e.enlarge(CKEDITOR.ENLARGE_ELEMENT)});var r=l[0].getBoundaryNodes(),s=r.startNode,i=r.endNode;if(s&&s.is&&s.is(a)){for(var d=s.getAscendant("table",!0),c=s.getPreviousSourceNode(!1,CKEDITOR.NODE_ELEMENT,d),u=!1;c&&!function(e){return!s.contains(e)&&e.is&&e.is("td","th")}(c);)c=c.getPreviousSourceNode(!1,CKEDITOR.NODE_ELEMENT,d);return!c&&i&&i.is&&!i.is("table")&&i.getNext()&&(c=i.getNext().findOne("td, th"),u=!0),c?o["moveToElementEdit"+(u?"Start":"End")](c):(o.setStartBefore(s.getAscendant("table",!0)),o.collapse(!0)),l[0].deleteContents(),[o]}return s?(o.moveToElementEditablePosition(s),[o]):void 0}var o={37:1,38:1,39:1,40:1,8:1,46:1},a=CKEDITOR.tools.extend({table:1},CKEDITOR.dtd.$tableContent);return delete a.td,delete a.th,function(a){var l,r,s,i,d,c=a.data.getKey(),u=37===c||38==c;if(o[c]&&(l=e.getSelection())&&l.isInTable()&&l.isFake)if(r=l.getRanges(),s=r[0]._getTableElement(),i=r[r.length-1]._getTableElement(),a.data.preventDefault(),a.cancel(),c>8&&c<46)r[0].moveToElementEditablePosition(u?s:i,!u),l.selectRanges([r[0]]);else{for(d=0;d<r.length;d++)t(r[d]);var g=n(0,r);g?r=g:r[0].moveToElementEditablePosition(s),l.selectRanges(r),e.fire("saveSnapshot")}}}(e),null,null,-1),n.attachListener(n,"keypress",function(n){var o,a,l,r=e.getSelection(),s=n.data.$.charCode||13===n.data.getKey();if(r&&r.isInTable()&&r.isFake&&s&&!(n.data.getKeystroke()&CKEDITOR.CTRL)){for(a=(o=r.getRanges())[0].getEnclosedNode().getAscendant({td:1,th:1},!0),l=0;l<o.length;l++)t(o[l]);o[0].moveToElementEditablePosition(a),r.selectRanges([o[0]])}},null,null,-1)},isSupportedEnvironment:!(CKEDITOR.env.ie&&CKEDITOR.env.version<11)},CKEDITOR.plugins.add("tableselection",{requires:"clipboard,tabletools",onLoad:function(){m=CKEDITOR.plugins.tabletools,E=m.getSelectedCells,C=m.getCellColIndex,T=m.insertRow,b=m.insertColumn,CKEDITOR.document.appendStyleSheet(this.path+"/styles/tableselection.css")},init:function(e){CKEDITOR.plugins.tableselection.isSupportedEnvironment&&(e.addContentsCss&&e.addContentsCss(this.path+"/styles/tableselection.css"),e.on("contentDom",function(){var t=e.editable(),n=t.isInline()?t:e.document,o={editor:e};t.attachListener(n,"mousedown",i,null,o),t.attachListener(n,"mousemove",i,null,o),t.attachListener(n,"mouseup",i,null,o),t.attachListener(t,"dragstart",d),t.attachListener(e,"selectionCheck",s),CKEDITOR.plugins.tableselection.keyboardIntegration(e),CKEDITOR.plugins.clipboard&&!CKEDITOR.plugins.clipboard.isCustomCopyCutSupported&&(t.attachListener(t,"cut",u),t.attachListener(t,"copy",u))}),e.on("paste",g),f(e,["rowInsertBefore","rowInsertAfter","columnInsertBefore","columnInsertAfter","cellInsertBefore","cellInsertAfter"],function(e,t){a(e,t.selectedCells)}),f(e,["cellMerge","cellMergeRight","cellMergeDown"],function(e,t){a(e,[t.commandData.cell])}),f(e,["cellDelete"],function(e){o(e,!0)}))}})}();