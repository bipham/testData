!function(){function e(e,t){if(0===e.length)return!1;var n;if(!t&&1===e.length&&(e[0].collapsed||function(e){var t,n=e.startContainer.getAscendant({td:1,th:1},!0),o=e.endContainer.getAscendant({td:1,th:1},!0),i=CKEDITOR.tools.trim;return!(!n||!n.equals(o)||n.findOne("td, th, tr, tbody, table")||(t=e.cloneContents()).getFirst()&&i(t.getFirst().getText())===i(n.getText()))}(e[0])))return!1;for(n=0;n<e.length;n++)if(!e[n]._getTableElement())return!1;return!0}function t(t,n){function o(e,t){return!(!e||!t)&&(e.equals(t)||t.contains(e))}var i=t.getRanges(),r=n.getRanges(),a=i.length&&i[0]._getTableElement()&&i[0]._getTableElement().getAscendant("table",!0),s=r.length&&r[0]._getTableElement()&&r[0]._getTableElement().getAscendant("table",!0),c=1===i.length&&i[0]._getTableElement()&&i[0]._getTableElement().is("table"),l=1===r.length&&r[0]._getTableElement()&&r[0]._getTableElement().is("table");return!!function(t,n,i,r){var a=1===i.length&&i[0].collapsed,s=e(i,!!CKEDITOR.env.webkit)&&e(r);return o(t,n)&&(a||s)}(a,s,i,r)&&(c&&!l&&n.selectRanges(i),!0)}function n(e){var t,n,o=[];for(n=0;n<e.length;n++)(t=e[n]._getTableElement()).is&&t.is({td:1,th:1})?o.push(t):o=o.concat(function(e){var t,n=e.find("td, th"),o=[];for(t=0;t<n.count();t++)o.push(n.getItem(t));return o}(t));return o}function o(e){var t,o,i=n(e),r="",a=[];for(o=0;o<i.length;o++)t&&!t.equals(i[o].getAscendant("tr"))?(r+=a.join("\t")+"\n",t=i[o].getAscendant("tr"),a=[]):0===o&&(t=i[o].getAscendant("tr")),a.push(i[o].getText());return r+=a.join("\t")}function i(e){var t,n=this.root.editor,i=n.getSelection(1);this.reset(),D=!0,i.root.once("selectionchange",function(e){e.cancel()},null,null,0),i.selectRanges([e[0]]),(t=this._.cache).ranges=new CKEDITOR.dom.rangeList(e),t.type=CKEDITOR.SELECTION_TEXT,t.selectedElement=e[0]._getTableElement(),t.selectedText=o(e),t.nativeSel=null,this.isFake=1,this.rev=S++,n._.fakeSelection=this,D=!1,this.root.fire("selectionchange")}function r(){var e,n=this._.fakeSelection;if(n&&((e=this.getSelection(1))&&(e.isHidden()||t(e,n))||(n.reset(),n=0)),n||(n=e||this.getSelection(1))&&n.getType()!=CKEDITOR.SELECTION_NONE){this.fire("selectionCheck",n);var o=this.elementPath();if(!o.compare(this._.selectionPreviousPath)){var i=this._.selectionPreviousPath&&this._.selectionPreviousPath.blockLimit.equals(o.blockLimit);CKEDITOR.env.webkit&&!i&&(this._.previousActive=this.document.getActive()),this._.selectionPreviousPath=o,this.fire("selectionChange",{selection:n,path:o})}}}function a(){p=!0,I||(s.call(this),I=CKEDITOR.tools.setTimeout(s,200,this))}function s(){I=null,p&&(CKEDITOR.tools.setTimeout(r,0,this),p=!1)}function c(e){return!!k(e)||e.type==CKEDITOR.NODE_ELEMENT&&!e.is(CKEDITOR.dtd.$empty)}function l(e){function t(t,n){return!(!t||t.type==CKEDITOR.NODE_TEXT)&&e.clone()["moveToElementEdit"+(n?"End":"Start")](t)}if(!(e.root instanceof CKEDITOR.editable))return!1;var n=e.startContainer,o=e.getPreviousNode(c,null,n),i=e.getNextNode(c,null,n);return!(!t(o)&&!t(i,1)&&(o||i||n.type==CKEDITOR.NODE_ELEMENT&&n.isBlockBoundary()&&n.getBogus()))}function E(e){u(e,!1);var t=e.getDocument().createText(K);return e.setCustomData("cke-fillingChar",t),t}function d(e){var t=e.getCustomData("cke-fillingChar");t&&(t.getCustomData("ready")?(u(e),e.editor.fire("selectionCheck")):t.setCustomData("ready",1))}function u(e,t){var n=e&&e.removeCustomData("cke-fillingChar");if(n){if(!1!==t){var o=e.getDocument().getSelection().getNative(),i=o&&"None"!=o.type&&o.getRangeAt(0),r=K.length;if(n.getLength()>r&&i&&i.intersectsNode(n.$)){var a=h(o);o.anchorNode==n.$&&o.anchorOffset>r&&(a[0].offset-=r),o.focusNode==n.$&&o.focusOffset>r&&(a[1].offset-=r)}}n.setText(f(n.getText(),1)),a&&T(e.getDocument().$,a)}}function f(e,t){return t?e.replace(_,function(e,t){return t?" ":""}):e.replace(K,"")}function h(e){return[{node:e.anchorNode,offset:e.anchorOffset},{node:e.focusNode,offset:e.focusOffset}]}function T(e,t){var n=e.getSelection(),o=e.createRange();o.setStart(t[0].node,t[0].offset),o.collapse(!0),n.removeAllRanges(),n.addRange(o),n.extend(t[1].node,t[1].offset)}function g(e,t){var n=t||"&nbsp;",o=CKEDITOR.env.ie&&CKEDITOR.env.version<14?"display:none":"position:fixed;top:0;left:-1000px",i=CKEDITOR.dom.element.createFromHtml('<div data-cke-hidden-sel="1" data-cke-temp="1" style="'+o+'">'+n+"</div>",e.document);e.fire("lockSnapshot"),e.editable().append(i);var r=e.getSelection(1),a=e.createRange(),s=r.root.on("selectionchange",function(e){e.cancel()},null,null,0);a.setStartAt(i,CKEDITOR.POSITION_AFTER_START),a.setEndAt(i,CKEDITOR.POSITION_BEFORE_END),r.selectRanges([a]),s.removeListener(),e.fire("unlockSnapshot"),e._.hiddenSelectionContainer=i}function C(e){var t=e._.hiddenSelectionContainer;if(t){var n=e.checkDirty();e.fire("lockSnapshot"),t.remove(),e.fire("unlockSnapshot"),!n&&e.resetDirty()}delete e._.hiddenSelectionContainer}function v(e){var t={37:1,39:1,8:1,46:1};return function(n){var o=n.data.getKeystroke();if(t[o]){var i=e.getSelection().getRanges(),r=i[0];if(1==i.length&&r.collapsed){var a=r[o<38?"getPreviousEditableNode":"getNextEditableNode"]();a&&a.type==CKEDITOR.NODE_ELEMENT&&"false"==a.getAttribute("contenteditable")&&(e.getSelection().fake(a),n.data.preventDefault(),n.cancel())}}}}function O(e){var t,n,o,i;if(1==e.length&&!(i=e[0]).collapsed&&(t=i.getEnclosedNode())&&t.type==CKEDITOR.NODE_ELEMENT&&((o=i.clone()).shrink(CKEDITOR.SHRINK_ELEMENT,!0),(n=o.getEnclosedNode())&&n.type==CKEDITOR.NODE_ELEMENT&&(t=n),"false"==t.getAttribute("contenteditable")))return t}function m(e,t){for(var n,o=0;o<e.length;++o)(n=e[o]).endContainer.equals(t)&&(n.endOffset=Math.min(n.endOffset,t.getChildCount()))}function R(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.getCommonAncestor().isReadOnly()&&e.splice(t,1),!n.collapsed){if(n.startContainer.isReadOnly())for(var o,i=n.startContainer;i&&!((o=i.type==CKEDITOR.NODE_ELEMENT)&&i.is("body")||!i.isReadOnly());)o&&"false"==i.getAttribute("contentEditable")&&n.setStartAfter(i),i=i.getParent();var r=n.startContainer,a=n.endContainer,s=n.startOffset,c=n.endOffset,l=n.clone();r&&r.type==CKEDITOR.NODE_TEXT&&(s>=r.getLength()?l.setStartAfter(r):l.setStartBefore(r)),a&&a.type==CKEDITOR.NODE_TEXT&&(c?l.setEndAfter(a):l.setEndBefore(a));var E=new CKEDITOR.dom.walker(l);E.evaluator=function(o){if(o.type==CKEDITOR.NODE_ELEMENT&&o.isReadOnly()){var i=n.clone();return n.setEndBefore(o),n.collapsed&&e.splice(t--,1),o.getPosition(l.endContainer)&CKEDITOR.POSITION_CONTAINS||(i.setStartAfter(o),i.collapsed||e.splice(t+1,0,i)),!0}return!1},E.next()}}return e}var D,I,p,N="function"!=typeof window.getSelection,S=1,K=CKEDITOR.tools.repeat("​",7),_=new RegExp(K+"( )?","g"),k=CKEDITOR.dom.walker.invisible(1),y=function(){function e(e){return function(t){var n=t.editor.createRange();return n.moveToClosestEditablePosition(t.selected,e)&&t.editor.getSelection().selectRanges([n]),!1}}function t(e){return function(t){var n,o=t.editor,i=o.createRange();return(n=i.moveToClosestEditablePosition(t.selected,e))||(n=i.moveToClosestEditablePosition(t.selected,!e)),n&&o.getSelection().selectRanges([i]),o.fire("saveSnapshot"),t.selected.remove(),n||(i.moveToElementEditablePosition(o.editable()),o.getSelection().selectRanges([i])),o.fire("saveSnapshot"),!1}}var n=e(),o=e(1);return{37:n,38:n,39:o,40:o,8:t(),46:t(1)}}();CKEDITOR.on("instanceCreated",function(e){function t(){var e=n.getSelection();e&&e.removeAllRanges()}var n=e.editor;n.on("contentDom",function(){function e(){(l=new CKEDITOR.dom.selection(n.getSelection())).lock()}function t(e,t,n){try{e.moveToPoint(t,n)}catch(e){}}function o(){d.removeListener("mouseup",i),T.removeListener("mouseup",i)}function i(){o();var e=CKEDITOR.document.$.selection,t=e.createRange();"None"!=e.type&&t.parentElement().ownerDocument==E.$&&t.select()}function s(e){if(CKEDITOR.env.ie){var t=e.getRanges()[0],n=t?t.startContainer.getAscendant(function(e){return e.type==CKEDITOR.NODE_ELEMENT&&("false"==e.getAttribute("contenteditable")||"true"==e.getAttribute("contenteditable"))},!0):null;return t&&"false"==n.getAttribute("contenteditable")&&n}}var c,l,E=n.document,d=CKEDITOR.document,f=n.editable(),h=E.getBody(),T=E.getDocumentElement(),g=f.isInline();if(CKEDITOR.env.gecko&&f.attachListener(f,"focus",function(e){if(e.removeListener(),0!==c){var t=n.getSelection().getNative();if(t&&t.isCollapsed&&t.anchorNode==f.$){var o=n.createRange();o.moveToElementEditStart(f),o.select()}}},null,null,-2),f.attachListener(f,CKEDITOR.env.webkit?"DOMFocusIn":"focus",function(){c&&CKEDITOR.env.webkit&&(c=n._.previousActive&&n._.previousActive.equals(E.getActive()))&&null!=n._.previousScrollTop&&n._.previousScrollTop!=f.$.scrollTop&&(f.$.scrollTop=n._.previousScrollTop),n.unlockSelection(c),c=0},null,null,-1),f.attachListener(f,"mousedown",function(){c=0}),(CKEDITOR.env.ie||g)&&(N?f.attachListener(f,"beforedeactivate",e,null,null,-1):f.attachListener(n,"selectionCheck",e,null,null,-1),f.attachListener(f,CKEDITOR.env.webkit?"DOMFocusOut":"blur",function(){n.lockSelection(l),c=1},null,null,-1),f.attachListener(f,"mousedown",function(){c=0})),CKEDITOR.env.ie&&!g){var C;if(f.attachListener(f,"mousedown",function(e){if(2==e.data.$.button){var t=n.document.getSelection();t&&t.getType()!=CKEDITOR.SELECTION_NONE||(C=n.window.getScrollPosition())}}),f.attachListener(f,"mouseup",function(e){2==e.data.$.button&&C&&(n.document.$.documentElement.scrollLeft=C.x,n.document.$.documentElement.scrollTop=C.y),C=null}),"BackCompat"!=E.$.compatMode){if(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat){var O,m;T.on("mousedown",function(e){function n(e){if(e=e.data.$,O){var n=h.$.createTextRange();t(n,e.clientX,e.clientY),O.setEndPoint(m.compareEndPoints("StartToStart",n)<0?"EndToEnd":"StartToStart",n),O.select()}}function o(){d.removeListener("mouseup",i),T.removeListener("mouseup",i)}function i(){T.removeListener("mousemove",n),o(),O.select()}(e=e.data).getTarget().is("html")&&e.$.y<T.$.clientHeight&&e.$.x<T.$.clientWidth&&(t(O=h.$.createTextRange(),e.$.clientX,e.$.clientY),m=O.duplicate(),T.on("mousemove",n),d.on("mouseup",i),T.on("mouseup",i))})}CKEDITOR.env.version>7&&CKEDITOR.env.version<11&&T.on("mousedown",function(e){e.data.getTarget().is("html")&&(d.on("mouseup",i),T.on("mouseup",i))})}}if(f.attachListener(f,"selectionchange",r,n),f.attachListener(f,"keyup",a,n),f.attachListener(f,"keydown",function(e){var t=this.getSelection(1);s(t)&&(t.selectElement(s(t)),e.data.preventDefault())},n),f.attachListener(f,CKEDITOR.env.webkit?"DOMFocusIn":"focus",function(){n.forceNextSelectionCheck(),n.selectionChange(1)}),g&&(CKEDITOR.env.webkit||CKEDITOR.env.gecko)){var R;f.attachListener(f,"mousedown",function(){R=1}),f.attachListener(E.getDocumentElement(),"mouseup",function(){R&&a.call(n),R=0})}else f.attachListener(CKEDITOR.env.ie?f:E.getDocumentElement(),"mouseup",a,n);CKEDITOR.env.webkit&&f.attachListener(E,"keydown",function(e){switch(e.data.getKey()){case 13:case 33:case 34:case 35:case 36:case 37:case 39:case 8:case 45:case 46:f.hasFocus&&u(f)}},null,null,-1),f.attachListener(f,"keydown",v(n),null,null,-1)}),n.on("setData",function(){n.unlockSelection(),CKEDITOR.env.webkit&&t()}),n.on("contentDomUnload",function(){n.unlockSelection()}),CKEDITOR.env.ie9Compat&&n.on("beforeDestroy",t,null,null,9),n.on("dataReady",function(){delete n._.fakeSelection,delete n._.hiddenSelectionContainer,n.selectionChange(1)}),n.on("loadSnapshot",function(){var e=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_ELEMENT),t=n.editable().getLast(e);if(t&&t.hasAttribute("data-cke-hidden-sel")&&(t.remove(),CKEDITOR.env.gecko)){var o=n.editable().getFirst(e);o&&o.is("br")&&o.getAttribute("_moz_editor_bogus_node")&&o.remove()}},null,null,100),n.on("key",function(e){if("wysiwyg"==n.mode){var t=n.getSelection();if(t.isFake){var o=y[e.data.keyCode];return o?o({editor:n,selected:t.getSelectedElement(),selection:t,keyEvent:e}):void 0}}})}),CKEDITOR.env.webkit&&CKEDITOR.on("instanceReady",function(e){var t=e.editor;t.on("selectionChange",function(){d(t.editable())},null,null,-1),t.on("beforeSetMode",function(){u(t.editable())},null,null,-1),t.on("getSnapshot",function(e){e.data&&(e.data=f(e.data))},t,null,20),t.on("toDataFormat",function(e){e.data.dataValue=f(e.data.dataValue)},null,null,0)}),CKEDITOR.editor.prototype.selectionChange=function(e){(e?r:a).call(this)},CKEDITOR.editor.prototype.getSelection=function(e){if((this._.savedSelection||this._.fakeSelection)&&!e)return this._.savedSelection||this._.fakeSelection;var t=this.editable();return t&&"wysiwyg"==this.mode?new CKEDITOR.dom.selection(t):null},CKEDITOR.editor.prototype.lockSelection=function(e){return(e=e||this.getSelection(1)).getType()!=CKEDITOR.SELECTION_NONE&&(!e.isLocked&&e.lock(),this._.savedSelection=e,!0)},CKEDITOR.editor.prototype.unlockSelection=function(e){var t=this._.savedSelection;return!!t&&(t.unlock(e),delete this._.savedSelection,!0)},CKEDITOR.editor.prototype.forceNextSelectionCheck=function(){delete this._.selectionPreviousPath},CKEDITOR.dom.document.prototype.getSelection=function(){return new CKEDITOR.dom.selection(this)},CKEDITOR.dom.range.prototype.select=function(){var e=this.root instanceof CKEDITOR.editable?this.root.editor.getSelection():new CKEDITOR.dom.selection(this.root);return e.selectRanges([this]),e},CKEDITOR.SELECTION_NONE=1,CKEDITOR.SELECTION_TEXT=2,CKEDITOR.SELECTION_ELEMENT=3,CKEDITOR.dom.selection=function(e){if(e instanceof CKEDITOR.dom.selection){var t=e;e=e.root}var n=e instanceof CKEDITOR.dom.element;if(this.rev=t?t.rev:S++,this.document=e instanceof CKEDITOR.dom.document?e:e.getDocument(),this.root=n?e:this.document.getBody(),this.isLocked=0,this._={cache:{}},t)return CKEDITOR.tools.extend(this._.cache,t._.cache),this.isFake=t.isFake,this.isLocked=t.isLocked,this;var o,i,r=this.getNative();if(r)if(r.getRangeAt)o=(i=r.rangeCount&&r.getRangeAt(0))&&new CKEDITOR.dom.node(i.commonAncestorContainer);else{try{i=r.createRange()}catch(e){}o=i&&CKEDITOR.dom.element.get(i.item&&i.item(0)||i.parentElement())}return(!o||o.type!=CKEDITOR.NODE_ELEMENT&&o.type!=CKEDITOR.NODE_TEXT||!this.root.equals(o)&&!this.root.contains(o))&&(this._.cache.type=CKEDITOR.SELECTION_NONE,this._.cache.startElement=null,this._.cache.selectedElement=null,this._.cache.selectedText="",this._.cache.ranges=new CKEDITOR.dom.rangeList),this};var L={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};CKEDITOR.tools.extend(CKEDITOR.dom.selection,{_removeFillingCharSequenceString:f,_createFillingCharSequenceNode:E,FILLING_CHAR_SEQUENCE:K}),CKEDITOR.dom.selection.prototype={getNative:function(){return void 0!==this._.cache.nativeSel?this._.cache.nativeSel:this._.cache.nativeSel=N?this.document.$.selection:this.document.getWindow().$.getSelection()},getType:N?function(){var e=this._.cache;if(e.type)return e.type;var t=CKEDITOR.SELECTION_NONE;try{var n=this.getNative(),o=n.type;"Text"==o&&(t=CKEDITOR.SELECTION_TEXT),"Control"==o&&(t=CKEDITOR.SELECTION_ELEMENT),n.createRange().parentElement()&&(t=CKEDITOR.SELECTION_TEXT)}catch(e){}return e.type=t}:function(){var e=this._.cache;if(e.type)return e.type;var t=CKEDITOR.SELECTION_TEXT,n=this.getNative();if(n&&n.rangeCount){if(1==n.rangeCount){var o=n.getRangeAt(0),i=o.startContainer;i==o.endContainer&&1==i.nodeType&&o.endOffset-o.startOffset==1&&L[i.childNodes[o.startOffset].nodeName.toLowerCase()]&&(t=CKEDITOR.SELECTION_ELEMENT)}}else t=CKEDITOR.SELECTION_NONE;return e.type=t},getRanges:function(){var e=N?function(){function e(e){return new CKEDITOR.dom.node(e).getIndex()}var t=function(t,n){(t=t.duplicate()).collapse(n);var o=t.parentElement();if(!o.hasChildNodes())return{container:o,offset:0};for(var i,r,a,s,c,l=o.children,E=t.duplicate(),d=0,u=l.length-1,f=-1;d<=u;)if(f=Math.floor((d+u)/2),i=l[f],E.moveToElementText(i),(a=E.compareEndPoints("StartToStart",t))>0)u=f-1;else{if(!(a<0))return{container:o,offset:e(i)};d=f+1}if(-1==f||f==l.length-1&&a<0){if(E.moveToElementText(o),E.setEndPoint("StartToStart",t),s=E.text.replace(/(\r\n|\r)/g,"\n").length,l=o.childNodes,!s)return(i=l[l.length-1]).nodeType!=CKEDITOR.NODE_TEXT?{container:o,offset:l.length}:{container:i,offset:i.nodeValue.length};for(var h=l.length;s>0&&h>0;)(r=l[--h]).nodeType==CKEDITOR.NODE_TEXT&&(c=r,s-=r.nodeValue.length);return{container:c,offset:-s}}if(E.collapse(a>0),E.setEndPoint(a>0?"StartToStart":"EndToStart",t),!(s=E.text.replace(/(\r\n|\r)/g,"\n").length))return{container:o,offset:e(i)+(a>0?0:1)};for(;s>0;)try{(r=i[a>0?"previousSibling":"nextSibling"]).nodeType==CKEDITOR.NODE_TEXT&&(s-=r.nodeValue.length,c=r),i=r}catch(t){return{container:o,offset:e(i)}}return{container:c,offset:a>0?-s:c.nodeValue.length+s}};return function(){var e,n=this.getNative(),o=n&&n.createRange(),i=this.getType();if(!n)return[];if(i==CKEDITOR.SELECTION_TEXT){e=new CKEDITOR.dom.range(this.root);var r=t(o,!0);return e.setStart(new CKEDITOR.dom.node(r.container),r.offset),r=t(o),e.setEnd(new CKEDITOR.dom.node(r.container),r.offset),e.endContainer.getPosition(e.startContainer)&CKEDITOR.POSITION_PRECEDING&&e.endOffset<=e.startContainer.getIndex()&&e.collapse(),[e]}if(i==CKEDITOR.SELECTION_ELEMENT){for(var a=[],s=0;s<o.length;s++){var c=o.item(s),l=c.parentNode,E=0;for(e=new CKEDITOR.dom.range(this.root);E<l.childNodes.length&&l.childNodes[E]!=c;E++);e.setStart(new CKEDITOR.dom.node(l),E),e.setEnd(new CKEDITOR.dom.node(l),E+1),a.push(e)}return a}return[]}}():function(){var e,t=[],n=this.getNative();if(!n)return t;for(var o=0;o<n.rangeCount;o++){var i=n.getRangeAt(o);(e=new CKEDITOR.dom.range(this.root)).setStart(new CKEDITOR.dom.node(i.startContainer),i.startOffset),e.setEnd(new CKEDITOR.dom.node(i.endContainer),i.endOffset),t.push(e)}return t};return function(t){var n=this._.cache,o=n.ranges;return o||(n.ranges=o=new CKEDITOR.dom.rangeList(e.call(this))),t?R(new CKEDITOR.dom.rangeList(o.slice())):o}}(),getStartElement:function(){var e=this._.cache;if(void 0!==e.startElement)return e.startElement;var t;switch(this.getType()){case CKEDITOR.SELECTION_ELEMENT:return this.getSelectedElement();case CKEDITOR.SELECTION_TEXT:var n=this.getRanges()[0];if(n){if(n.collapsed)(t=n.startContainer).type!=CKEDITOR.NODE_ELEMENT&&(t=t.getParent());else{for(n.optimize();;){var o=n.startContainer;if(n.startOffset!=(o.getChildCount?o.getChildCount():o.getLength())||o.isBlockBoundary())break;n.setStartAfter(o)}if((t=n.startContainer).type!=CKEDITOR.NODE_ELEMENT)return t.getParent();if((t=t.getChild(n.startOffset))&&t.type==CKEDITOR.NODE_ELEMENT)for(var i=t.getFirst();i&&i.type==CKEDITOR.NODE_ELEMENT;)t=i,i=i.getFirst();else t=n.startContainer}t=t.$}}return e.startElement=t?new CKEDITOR.dom.element(t):null},getSelectedElement:function(){var e=this._.cache;if(void 0!==e.selectedElement)return e.selectedElement;var t=this,n=CKEDITOR.tools.tryThese(function(){return t.getNative().createRange().item(0)},function(){for(var e,n,o=t.getRanges()[0].clone(),i=2;i&&!((e=o.getEnclosedNode())&&e.type==CKEDITOR.NODE_ELEMENT&&L[e.getName()]&&(n=e));i--)o.shrink(CKEDITOR.SHRINK_ELEMENT);return n&&n.$});return e.selectedElement=n?new CKEDITOR.dom.element(n):null},getSelectedText:function(){var e=this._.cache;if(void 0!==e.selectedText)return e.selectedText;var t=this.getNative(),n=N?"Control"==t.type?"":t.createRange().text:t.toString();return e.selectedText=n},lock:function(){this.getRanges(),this.getStartElement(),this.getSelectedElement(),this.getSelectedText(),this._.cache.nativeSel=null,this.isLocked=1},unlock:function(t){if(this.isLocked){if(t)var n=this.getSelectedElement(),o=this.getRanges(),r=this.isFake;if(this.isLocked=0,this.reset(),t){var a=n||o[0]&&o[0].getCommonAncestor();if(!a||!a.getAscendant("body",1))return;e(o)?i.call(this,o):r?this.fake(n):n?this.selectElement(n):this.selectRanges(o)}}},reset:function(){this._.cache={},this.isFake=0;var e=this.root.editor;e&&e._.fakeSelection&&(this.rev==e._.fakeSelection.rev?(delete e._.fakeSelection,C(e)):CKEDITOR.warn("selection-fake-reset")),this.rev=S++},selectElement:function(e){var t=new CKEDITOR.dom.range(this.root);t.setStartBefore(e),t.setEndAfter(e),this.selectRanges([t])},selectRanges:function(t){var n=this.root.editor,o=n&&n._.hiddenSelectionContainer;if(this.reset(),o&&m(t,this.root),t.length){if(this.isLocked){var r=CKEDITOR.document.getActive();return this.unlock(),this.selectRanges(t),this.lock(),void(r&&!r.equals(this.root)&&r.focus())}var a=O(t);if(a)this.fake(a);else if(n&&n.plugins.tableselection&&CKEDITOR.plugins.tableselection.isSupportedEnvironment&&e(t)&&!D)i.call(this,t);else{if(N){var s=CKEDITOR.dom.walker.whitespaces(!0),c=/\ufeff|\u00a0/,d={table:1,tbody:1,tr:1};if(t.length>1){var f=t[t.length-1];t[0].setEnd(f.endContainer,f.endOffset)}var h,T,g,C=t[0],v=C.collapsed,R=C.getEnclosedNode();if(R&&R.type==CKEDITOR.NODE_ELEMENT&&R.getName()in L&&(!R.is("a")||!R.getText()))try{return(g=R.$.createControlRange()).addElement(R.$),void g.select()}catch(e){}(C.startContainer.type==CKEDITOR.NODE_ELEMENT&&C.startContainer.getName()in d||C.endContainer.type==CKEDITOR.NODE_ELEMENT&&C.endContainer.getName()in d)&&(C.shrink(CKEDITOR.NODE_ELEMENT,!0),v=C.collapsed);var I,p=C.createBookmark(),S=p.startNode;if(v||(I=p.endNode),(g=C.document.$.body.createTextRange()).moveToElementText(S.$),g.moveStart("character",1),I){var K=C.document.$.body.createTextRange();K.moveToElementText(I.$),g.setEndPoint("EndToEnd",K),g.moveEnd("character",-1)}else{var _=S.getNext(s),k=S.hasAscendant("pre");h=!(_&&_.getText&&_.getText().match(c))&&(k||!S.hasPrevious()||S.getPrevious().is&&S.getPrevious().is("br")),(T=C.document.createElement("span")).setHtml("&#65279;"),T.insertBefore(S),h&&C.document.createText("\ufeff").insertBefore(S)}C.setStartBefore(S),S.remove(),v?(h?(g.moveStart("character",-1),g.select(),C.document.$.selection.clear()):g.select(),C.moveToPosition(T,CKEDITOR.POSITION_BEFORE_START),T.remove()):(C.setEndBefore(I),I.remove(),g.select())}else{var y=this.getNative();if(!y)return;this.removeAllRanges();for(var b=0;b<t.length;b++){if(b<t.length-1){var w=t[b],A=t[b+1],x=w.clone();if(x.setStart(w.endContainer,w.endOffset),x.setEnd(A.startContainer,A.startOffset),!x.collapsed){x.shrink(CKEDITOR.NODE_ELEMENT,!0);var P=x.getCommonAncestor(),$=x.getEnclosedNode();if(P.isReadOnly()||$&&$.isReadOnly()){A.setStart(w.startContainer,w.startOffset),t.splice(b--,1);continue}}}C=t[b];var M=this.document.$.createRange();if(C.collapsed&&CKEDITOR.env.webkit&&l(C)){var F=E(this.root);C.insertNode(F),(_=F.getNext())&&!F.getPrevious()&&_.type==CKEDITOR.NODE_ELEMENT&&"br"==_.getName()?(u(this.root),C.moveToPosition(_,CKEDITOR.POSITION_BEFORE_START)):C.moveToPosition(F,CKEDITOR.POSITION_AFTER_END)}M.setStart(C.startContainer.$,C.startOffset);try{M.setEnd(C.endContainer.$,C.endOffset)}catch(e){if(!(e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0))throw e;C.collapse(1),M.setEnd(C.endContainer.$,C.endOffset)}y.addRange(M)}}this.reset(),this.root.fire("selectionchange")}}},fake:function(e,t){var n=this.root.editor;void 0===t&&e.hasAttribute("aria-label")&&(t=e.getAttribute("aria-label")),this.reset(),g(n,t);var o=this._.cache,i=new CKEDITOR.dom.range(this.root);i.setStartBefore(e),i.setEndAfter(e),o.ranges=new CKEDITOR.dom.rangeList(i),o.selectedElement=o.startElement=e,o.type=CKEDITOR.SELECTION_ELEMENT,o.selectedText=o.nativeSel=null,this.isFake=1,this.rev=S++,n._.fakeSelection=this,this.root.fire("selectionchange")},isHidden:function(){var e=this.getCommonAncestor();return e&&e.type==CKEDITOR.NODE_TEXT&&(e=e.getParent()),!(!e||!e.data("cke-hidden-sel"))},isInTable:function(){return e(this.getRanges())},createBookmarks:function(e){var t=this.getRanges().createBookmarks(e);return this.isFake&&(t.isFake=1),t},createBookmarks2:function(e){var t=this.getRanges().createBookmarks2(e);return this.isFake&&(t.isFake=1),t},selectBookmarks:function(t){for(var n,o=[],i=0;i<t.length;i++){var r=new CKEDITOR.dom.range(this.root);r.moveToBookmark(t[i]),o.push(r)}return t.isFake&&((n=e(o)?o[0]._getTableElement():o[0].getEnclosedNode())&&n.type==CKEDITOR.NODE_ELEMENT||(CKEDITOR.warn("selection-not-fake"),t.isFake=0)),t.isFake&&!e(o)?this.fake(n):this.selectRanges(o),this},getCommonAncestor:function(){var e=this.getRanges();if(!e.length)return null;var t=e[0].startContainer,n=e[e.length-1].endContainer;return t.getCommonAncestor(n)},scrollIntoView:function(){this.type!=CKEDITOR.SELECTION_NONE&&this.getRanges()[0].scrollIntoView()},removeAllRanges:function(){if(this.getType()!=CKEDITOR.SELECTION_NONE){var e=this.getNative();try{e&&e[N?"empty":"removeAllRanges"]()}catch(e){}this.reset()}}}}();