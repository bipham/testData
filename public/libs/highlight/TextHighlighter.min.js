!function(e){function t(e,t){return h(e).color()===h(t).color()}function n(e,t){e=e||{};for(var n in t)t.hasOwnProperty(n)&&void 0===e[n]&&(e[n]=t[n]);return e}function i(e){return e.filter(function(e,t,n){return n.indexOf(e)===t})}function o(e,t){e.sort(function(e,n){return h(t?n:e).parents().length-h(t?e:n).parents().length})}function r(e){var t=[],n={},i=[];return e.forEach(function(e){var i=e.getAttribute("data-timestamp");void 0===n[i]&&(n[i]=[],t.push(i)),n[i].push(e)}),t.forEach(function(e){var t=n[e];i.push({chunks:t,timestamp:e,toString:function(){return t.map(function(e){return e.textContent}).join("")}})}),i}function l(e,t){e.addEventListener("mouseup",t.highlightHandler.bind(t)),e.addEventListener("touchend",t.highlightHandler.bind(t))}function s(e,t){if(!e)throw"Missing anchor element";this.el=e,this.options=n(t,{color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}),h(this.el).addClass(this.options.contextClass),l(this.el,this)}var a="SCRIPT STYLE SELECT OPTION BUTTON OBJECT APPLET VIDEO AUDIO CANVAS EMBED PARAM METER PROGRESS".split(" "),h=function(e){return{addClass:function(t){e.classList?e.classList.add(t):e.className+=" "+t},removeClass:function(t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t+"(\\b|$)","gi")," ")},prepend:function(t){for(var n=(t=Array.prototype.slice.call(t)).length;n--;)e.insertBefore(t[n],e.firstChild)},append:function(t){for(var n=0,i=(t=Array.prototype.slice.call(t)).length;n<i;++n)e.appendChild(t[n])},insertAfter:function(t){return t.parentNode.insertBefore(e,t.nextSibling)},insertBefore:function(t){return t.parentNode.insertBefore(e,t)},remove:function(){e.parentNode.removeChild(e),e=null},contains:function(t){return e!==t&&e.contains(t)},wrap:function(t){return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),t},unwrap:function(){var t,n=Array.prototype.slice.call(e.childNodes);return n.forEach(function(e){t=e.parentNode,h(e).insertBefore(e.parentNode),h(t).remove()}),n},parents:function(){for(var t,n=[];t=e.parentNode;)n.push(t),e=t;return n},normalizeTextNodes:function(){if(e){if(3===e.nodeType)for(;e.nextSibling&&3===e.nextSibling.nodeType;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else h(e.firstChild).normalizeTextNodes();h(e.nextSibling).normalizeTextNodes()}},color:function(){return e.style.backgroundColor},fromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes},getRange:function(){var t,n=h(e).getSelection();return 0<n.rangeCount&&(t=n.getRangeAt(0)),t},removeAllRanges:function(){h(e).getSelection().removeAllRanges()},getSelection:function(){return h(e).getWindow().getSelection()},getWindow:function(){return h(e).getDocument().defaultView},getDocument:function(){return e.ownerDocument||e}}};s.prototype.destroy=function(){var e=this.el;e.removeEventListener("mouseup",this.highlightHandler.bind(this)),e.removeEventListener("touchend",this.highlightHandler.bind(this)),h(this.el).removeClass(this.options.contextClass)},s.prototype.highlightHandler=function(){this.doHighlight()},s.prototype.doHighlight=function(e){var t,n,i=h(this.el).getRange();i&&!i.collapsed&&(!0===this.options.onBeforeHighlight(i)&&(n=+new Date,(t=s.createWrapper(this.options)).setAttribute("data-timestamp",n),t=this.highlightRange(i,t),t=this.normalizeHighlights(t),this.options.onAfterHighlight(i,t,n)),e||h(this.el).removeAllRanges())},s.prototype.highlightRange=function(e,t){var n;if(!e||e.collapsed)return[];var i=e.startContainer;n=e.endContainer;var o=e.commonAncestorContainer,r=!0;if(0===e.endOffset){for(;!n.previousSibling&&n.parentNode!==o;)n=n.parentNode;n=n.previousSibling}else 3===n.nodeType?e.endOffset<n.nodeValue.length&&n.splitText(e.endOffset):0<e.endOffset&&(n=n.childNodes.item(e.endOffset-1));3===i.nodeType?e.startOffset===i.nodeValue.length?r=!1:0<e.startOffset&&(i=i.splitText(e.startOffset),n===i.previousSibling&&(n=i)):i=e.startOffset<i.childNodes.length?i.childNodes.item(e.startOffset):i.nextSibling;var l,s=r,r=!1,o=[];do{s&&3===i.nodeType&&(-1===a.indexOf(i.parentNode.tagName)&&""!==i.nodeValue.trim()&&((s=t.cloneNode(!0)).setAttribute("data-highlighted",!0),l=i.parentNode,h(this.el).contains(l)||l===this.el)&&(s=h(i).wrap(s),o.push(s)),s=!1),i!==n||n.hasChildNodes()&&s||(r=!0),i.tagName&&-1<a.indexOf(i.tagName)&&(n.parentNode===i&&(r=!0),s=!1),s&&i.hasChildNodes()?i=i.firstChild:i.nextSibling?(i=i.nextSibling,s=!0):(i=i.parentNode,s=!1)}while(!r);return o},s.prototype.normalizeHighlights=function(e){return this.flattenNestedHighlights(e),this.mergeSiblingHighlights(e),e=e.filter(function(e){return e.parentElement?e:null}),(e=i(e)).sort(function(e,t){return e.offsetTop-t.offsetTop||e.offsetLeft-t.offsetLeft}),e},s.prototype.flattenNestedHighlights=function(e){var n,i=this;o(e,!0);do{n=function(){var n=!1;return e.forEach(function(o,r){var l=o.parentElement,s=l.previousSibling,a=l.nextSibling;i.isHighlight(l)&&(t(l,o)?(l.replaceChild(o.firstChild,o),e[r]=l,n=!0):(o.nextSibling||(h(o).insertBefore(a||l),n=!0),o.previousSibling||(h(o).insertAfter(s||l),n=!0),l.hasChildNodes()||h(l).remove()))}),n}()}while(n)},s.prototype.mergeSiblingHighlights=function(e){function n(e,n){return n&&1===n.nodeType&&t(e,n)&&i.isHighlight(n)}var i=this;e.forEach(function(e){var t=e.previousSibling,i=e.nextSibling;n(e,t)&&(h(e).prepend(t.childNodes),h(t).remove()),n(e,i)&&(h(e).append(i.childNodes),h(i).remove()),h(e).normalizeTextNodes()})},s.prototype.setColor=function(e){this.options.color=e},s.prototype.getColor=function(){return this.options.color},s.prototype.removeHighlights=function(e){function t(e){h(e).unwrap().forEach(function(e){var t=e.previousSibling,n=e.nextSibling;t&&3===t.nodeType&&(e.nodeValue=t.nodeValue+e.nodeValue,h(t).remove()),n&&3===n.nodeType&&(e.nodeValue+=n.nodeValue,h(n).remove())})}var n=this;o(e=this.getHighlights({container:e||this.el}),!0),e.forEach(function(e){!0===n.options.onRemoveHighlight(e)&&t(e)})},s.prototype.getHighlights=function(e){var t=(e=n(e,{container:this.el,andSelf:!0,grouped:!1})).container.querySelectorAll("[data-highlighted]"),t=Array.prototype.slice.call(t);return!0===e.andSelf&&e.container.hasAttribute("data-highlighted")&&t.push(e.container),e.grouped&&(t=r(t)),t},s.prototype.isHighlight=function(e){return e&&1===e.nodeType&&e.hasAttribute("data-highlighted")},s.prototype.serializeHighlights=function(){var e=this.getHighlights(),t=this.el,n=[];return o(e,!1),e.forEach(function(e){var i,o=0,r=e.textContent.length,l=e,s=[];do{i=Array.prototype.slice.call(l.parentNode.childNodes),s.unshift(i.indexOf(l)),l=l.parentNode}while(l!==t||!l);(l=e.cloneNode(!0)).innerHTML="",l=l.outerHTML,e.previousSibling&&3===e.previousSibling.nodeType&&(o=e.previousSibling.length),n.push([l,e.textContent,s.join(":"),o,r])}),JSON.stringify(n)},s.prototype.deserializeHighlights=function(e){var t,n=[],i=this;if(!e)return n;try{t=JSON.parse(e)}catch(e){throw"Can't parse JSON: "+e}return t.forEach(function(e){try{for(var t,o,r,l=e[0],s=e[2].split(":"),a=e[3],g=e[4],d=s.pop(),c=i.el;r=s.shift();)c=c.childNodes[r];c.childNodes[d-1]&&3===c.childNodes[d-1].nodeType&&--d,(t=(c=c.childNodes[d]).splitText(a)).splitText(g),t.nextSibling&&!t.nextSibling.nodeValue&&h(t.nextSibling).remove(),t.previousSibling&&!t.previousSibling.nodeValue&&h(t.previousSibling).remove(),o=h(t).wrap(h().fromHTML(l)[0]),n.push(o)}catch(e){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+e)}}),n},s.prototype.find=function(e,t){var n=h(this.el).getWindow(),i=n.scrollX,o=n.scrollY,r=void 0===t||t;if(h(this.el).removeAllRanges(),n.find)for(;n.find(e,r);)this.doHighlight(!0);else if(n.document.body.createTextRange){var l=n.document.body.createTextRange();for(l.moveToElementText(this.el);l.findText(e,1,r?4:0)&&(h(this.el).contains(l.parentElement())||l.parentElement()===this.el);)l.select(),this.doHighlight(!0),l.collapse(!1)}h(this.el).removeAllRanges(),n.scrollTo(i,o)},s.createWrapper=function(e){var t=document.createElement("span");return t.style.backgroundColor=e.color,t.className=e.highlightedClass,t},e.TextHighlighter=s}(window),function(e){function t(e,t){return function(){t.call(this,e)}}e.fn.getHighlighter=function(){return this.data("textHighlighter")},e.fn.textHighlighter=function(n){return this.each(function(){var i,o=this;e.data(o,"textHighlighter")||(i=new TextHighlighter(o,n),i.destroy=t(i.destroy,function(t){t.call(i),e(o).removeData("textHighlighter")}),e.data(o,"textHighlighter",i))})}}(jQuery);